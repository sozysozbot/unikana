<!DOCTYPE html>
<html>
<meta charset="utf-8">

<head>
    <title>ユニかな！　ステージ 1-1</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
    <script>
        function insertAtCursor(inputElement, textToInsert) {
            // Get the current text of the input element
            const currentValue = inputElement.value;
            // Get the start and end positions of the cursor
            const start = inputElement.selectionStart ?? 0;
            const end = inputElement.selectionEnd ?? 0;
            // Insert the text at the cursor position
            inputElement.value = currentValue.slice(0, start) + textToInsert + currentValue.slice(end);
            // Move the cursor after the inserted text
            inputElement.setSelectionRange(start + textToInsert.length, start + textToInsert.length);

            clickSound();
        }

        function beep() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            oscillator.type = "sawtooth";
            oscillator.frequency.setValueAtTime(98, audioContext.currentTime); // Pitch: G2
            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        function clickSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();

            const bufferSize = audioContext.sampleRate * 0.05 /* seconds */;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                data[i] = Math.random() * 2 - 1;
            }

            const noise = audioContext.createBufferSource();
            noise.buffer = buffer;

            const highPass = audioContext.createBiquadFilter();
            highPass.type = "highpass";
            highPass.frequency.setValueAtTime(500 /*Hz*/, audioContext.currentTime);

            const lowPass = audioContext.createBiquadFilter();
            lowPass.type = "lowpass";
            lowPass.frequency.setValueAtTime(1500 /*Hz*/, audioContext.currentTime);

            const gainNode = audioContext.createGain();
            gainNode.gain.setValueAtTime(0.9, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05/* seconds; decay*/);

            noise.connect(highPass);
            highPass.connect(lowPass);
            lowPass.connect(gainNode);
            gainNode.connect(audioContext.destination);

            noise.start();
        }

        function sync() {
            for (let i = 0; i < 2; i++) {
                let codepoint_input = document.getElementById("codepoint" + i).value;
                const char_div = document.getElementById("char" + i);

                // Delete offending characters
                if (!document.getElementById("codepoint" + i).checkValidity()) { 
                    codepoint_input = "";
                    document.getElementById("codepoint" + i).value = "";
                    beep();
                }

                if (codepoint_input === "") {
                    char_div.textContent = "";
                    char_div.classList.add("unfilled-char-cell");
                } else {
                    char_div.textContent = String.fromCodePoint(parseInt("306" + codepoint_input, 16));
                    char_div.classList.remove("unfilled-char-cell");
                }
            }
        }
    </script>
</head>

<body>

    <table class="keyboard">
        <tr>
            <td class="no-entry" onclick="beep()">⛔</td>
            <td class="no-entry" onclick="beep()">⛔</td>
            <td class="no-entry" onclick="beep()">⛔</td>
            <td class="no-entry" onclick="beep()">⛔</td>
        </tr>
        <tr>
            <td class="no-entry" onclick="beep()">⛔</td>
            <td class="no-entry" onclick="beep()">⛔</td>
            <td class="no-entry" onclick="beep()">⛔</td>
            <td class="no-entry" onclick="beep()">⛔</td>
        </tr>
        <tr>
            <td class="no-entry" onclick="beep()">⛔</td>
            <td class="no-entry" onclick="beep()">⛔</td>
            <td onclick="insertAtCursor(document.getElementById('search-bar'), 'A')">A</td>
            <td onclick="insertAtCursor(document.getElementById('search-bar'), 'B')">B</td>
        </tr>
        <tr>
            <td onclick="insertAtCursor(document.getElementById('search-bar'), 'C')">C</td>
            <td onclick="insertAtCursor(document.getElementById('search-bar'), 'D')">D</td>
            <td onclick="insertAtCursor(document.getElementById('search-bar'), 'E')">E</td>
            <td class="no-entry" onclick="beep()">⛔</td>
        </tr>
    </table>

    <div class="outer-container">
        <h1 style="position: absolute; font-size: 15px; right: 0px; margin-top: 0; margin-right: 3px"><img
                src="logo.png" width="100" alt="ユニかな！"></h1>
        <h2 style="position: absolute; font-size: 15px; margin-top: 0;margin-left: 3px">ステージ 1-1</h2>

        <div id="challenge-text" style="text-align: center; font-size: 40px; margin-top: 10px;"><ruby>七<rt>なな</rt>
            </ruby></div>
        <div class="input-container">
            <div class="grid" style="height: 80px; margin: 50px auto 0 auto; ">
                <div id="char0" class="grid-char-cell unfilled-char-cell"></div>
                <div id="char1" class="grid-char-cell unfilled-char-cell"></div>
                <div class="grid-unicode-cell"><span class="immutable">U+306</span><input class="single-digit-codepoint"
                        type="text" size="1" maxlength="1" pattern="[A-Ea-e]" id="codepoint0" autofocus
                        oninput="sync()"></div>
                <div class="grid-unicode-cell"><span class="immutable">U+306</span><input class="single-digit-codepoint"
                        type="text" size="1" maxlength="1" pattern="[A-Ea-e]" id="codepoint1" oninput="sync()"></div>
            </div>
        </div>
    </div>

    <input type="text" id="search-bar" value="" accesskey="f" autocapitalize="none" autocomplete="off">

    <table>
        <tr>
            <td>A</td>
            <td>B</td>
            <td>C</td>
            <td>D</td>
            <td>E</td>
        </tr>
        <tr>
            <td>な</td>
            <td>に</td>
            <td>ぬ</td>
            <td>ね</td>
            <td>の</td>
    </table>
</body>